<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<link rel="stylesheet" href="assets/style.css">
<title>Build Racers Ultimate V7</title>

<style>
body { margin:0; background:#87ceeb; font-family:Arial; text-align:center; }
canvas { background:#a0d8f1; border:4px solid #000; display:block; margin:20px auto; }
button, select, input { padding:6px 10px; margin:5px; font-size:14px; cursor:pointer; }
#leaderboard { margin-top:15px; font-size:16px; text-align:left; display:inline-block; }
</style>

</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="index.html">Rowan's Prjects</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav"
    aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav ml-auto">
        <li class="nav-item">
        <a class="nav-link" href="index.html">Home<span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
        <a class="nav-link" href="mini city.html">Mini City</a>
        </li>
        <li class="nav-item active">
        <a class="nav-link" href="build racers.html">Build Racers</a>
        </li>
    </ul>
    </div>
</nav>

<h1>Build Racers Ultimate V7</h1>

<div id="controls">
  <button onclick="setTile(0)">Ground</button>
  <button onclick="setTile(1)">Ramp</button>
  <button onclick="setTile(2)">Sand</button>
  <button onclick="setTile(3)">Boost</button>
  <button onclick="setTile(4)">Obstacle</button>
  <button onclick="placeEndRamp()">End Ramp</button>
  <button onclick="undoTile()">Undo</button>
  <br>

  <label>Player 1 Color:</label>
  <input type="color" id="p1Color" value="#ff0000">

  <label>Player 2 Color:</label>
  <input type="color" id="p2Color" value="#0000ff">

  <label>Laps:</label>
  <input type="number" id="numLaps" value="3" min="1" max="10" style="width:50px">

  <button onclick="startRace()">RACE!</button>
</div>

<canvas id="gameCanvas" width="900" height="300"></canvas>
<div id="leaderboard"></div>

<script>
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");

const TILE_SIZE=40;
const ROWS=6;
const COLS=120;

let track=Array(ROWS).fill(0).map(()=>Array(COLS).fill(0));
let selectedTile=0;
let history=[];
let cameraX=0;
let racing=false;
let bikes=[];
let totalLaps=3;
let raceStartTime=0;

const colors=["#654321","#bbbbbb","#F2E7A1","#FFD700","#333333"]; // ground/ramp/sand/boost/obstacle

function setTile(t){ selectedTile=t; }

function placeEndRamp(){
  // Entire last column becomes ramp
  for(let r=0;r<ROWS;r++){
    track[r][COLS-1]=1;
  }
  drawTrack();
}

// ==== TRACK EDITOR CLICK ====
canvas.addEventListener("click",e=>{
  if(racing) return;
  const rect=canvas.getBoundingClientRect();
  const x=Math.floor((e.clientX-rect.left + cameraX)/TILE_SIZE);
  const y=Math.floor((e.clientY-rect.top)/TILE_SIZE);

  if(x<0||x>=COLS||y<0||y>=ROWS) return;

  history.push({y,x,prev:track[y][x]});
  track[y][x]=selectedTile;

  drawTrack();
});

function undoTile(){
  const h=history.pop();
  if(!h) return;
  track[h.y][h.x]=h.prev;
  drawTrack();
}

// ==== DRAW TRACK ====
function drawTrack(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      ctx.fillStyle=colors[track[r][c]];
      ctx.fillRect(c*TILE_SIZE-cameraX,r*TILE_SIZE,TILE_SIZE,TILE_SIZE);
      ctx.strokeStyle="#000"; ctx.strokeRect(c*TILE_SIZE-cameraX,r*TILE_SIZE,TILE_SIZE,TILE_SIZE);
    }
  }

  if(!racing) bikes.forEach(drawBike);
}

function drawBike(b){
  ctx.save();
  ctx.translate(b.x-cameraX+20, b.y);
  ctx.rotate(b.angle);
  ctx.fillStyle=b.color;
  ctx.fillRect(-20,-10,40,20);
  ctx.restore();
}

// ==== START RACE ====
function startRace(){
  racing=true;
  totalLaps=parseInt(document.getElementById("numLaps").value)||1;

  const p1=document.getElementById("p1Color").value;
  const p2=document.getElementById("p2Color").value;

  // staggered starts
  bikes=[
    makeBike(30, 240, p1, "Player 1"),
    makeBike(60, 240, p2, "Player 2"),
    makeBike(90, 240, "#00ff00","AI 1"),
    makeBike(120,240,"#ff00ff","AI 2"),
    makeBike(150,240,"#00ffff","AI 3")
  ];

  raceStartTime=Date.now();
}

function makeBike(x,y,color,name){
  return {
    x, y,
    color,
    speed:2,
    vy:0,
    angle:0,
    onGround:true,
    finished:false,
    laps:1,
    name
  };
}

// ==== PHYSICS ====
function updateBikes(){
  bikes.forEach(b=>{

    if(b.finished) return;

    // AI simpler logic
    if(b.name.startsWith("AI")){
      b.speed += Math.random()*0.1;
      if(b.speed>4) b.speed=4;
    }

    // movement
    b.x += b.speed;

    // NO FALLING: y always goes back to ground unless jumping
    const groundY=240;

    // Ramp & boost behavior
    const col=Math.floor(b.x/TILE_SIZE);
    const tile=track[5][col]; // bottom row defines physics

    if(tile===1){ // ramp
      b.vy = -6; // jump
      b.angle = 0.3;
      b.onGround=false;
    }
    else if(tile===3){ // boost
      b.speed+=0.3;
      b.vy = -4;
      b.angle = 0.3;
      b.onGround=false;
    }
    else if(tile===4){ // obstacle
      b.speed*=0.8;
      b.angle = -0.3;
    }

    if(!b.onGround){
      b.vy+=0.35;
      b.y+=b.vy;
      if(b.y>=groundY){
        b.y=groundY;
        b.vy=0;
        b.angle=0;
        b.onGround=true;
      }
    }

    // End ramp / laps
    if(b.x>=(COLS-1)*TILE_SIZE){
      if(b.laps<totalLaps){
        b.laps++;
        b.x=30; b.y=groundY; b.speed=2; b.vy=0;
      } else {
        b.finished=true;
        saveResult(b);
      }
    }
  });

  cameraX = bikes[0].x - canvas.width/3;
  if(cameraX<0) cameraX=0;
}

// ==== LEADERBOARD ====
function saveResult(b){
  const time=((Date.now()-raceStartTime)/1000).toFixed(2);
  const div=document.getElementById("leaderboard");

  if(!div.innerHTML.includes("Results"))
    div.innerHTML="<h2>Results</h2>";

  div.innerHTML+=`${b.name}: ${time}s<br>`;
}

// ==== CONTROLS ====
const keys={};
document.addEventListener("keydown",e=>keys[e.key]=true);
document.addEventListener("keyup",e=>keys[e.key]=false);

function handleControls(){
  const p1=bikes[0];
  const p2=bikes[1];

  if(keys["ArrowUp"]) p1.speed+=0.2;
  if(keys["ArrowDown"]) p1.speed-=0.1;
  if(keys[" "] && p1.onGround){ p1.vy=-7; p1.onGround=false; }

  if(keys["w"]) p2.speed+=0.2;
  if(keys["s"]) p2.speed-=0.1;
  if(keys["v"] && p2.onGround){ p2.vy=-7; p2.onGround=false; }
}

// ==== MAIN LOOP ====
function gameLoop(){
  if(racing){
    handleControls();
    updateBikes();
    drawTrack();
    bikes.forEach(drawBike);
  }
  requestAnimationFrame(gameLoop);
}

drawTrack();
gameLoop();
</script>

</body>
</html>
